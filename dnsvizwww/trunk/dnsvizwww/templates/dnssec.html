{% extends "domain_page.html" %}

{% block extra_media %}

	{{ block.super }}

	{% if use_js %}
	<!-- Javascripts and associated styles -->
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.cookie.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/raphael-min.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/dnsviz.js"></script>
	<style type="text/css" media="screen">
		/* hide regions that require javascript */
		.toggle { display:none; }
	</style>
	<script type="text/javascript">
		<!--
		$(document).ready(function() {
			// turn on hidden regions if javascript is enabled
			$('.toggle').show();

			// visualization options
			$('#options .toggle').click(function() {
				var tog = $(this);
				$('#options form').slideToggle({
					'duration': 'slow',
					'complete': function() {
						if (tog.text() == 'hide') {
							tog.text('show');
							$('#options').css({'border-bottom':'0', 'border-left':'0', 'border-right':'0', 'padding-left' : '3px' });
						} else {
							tog.text('hide');
						}
					},
					'start': function() {
						if (tog.text() == 'show') {
							$('#options').removeAttr("style");
						}
					}
				});
			});

			{% if not options_form.errors %}
			$('#options form').hide();
			$('#options').css({'border-bottom':'0', 'border-left':'0', 'border-right':'0', 'padding-left' : '3px' });
			$('#options .toggle').text('show');
			{% endif %}
			

			// viz options tooltips
			$('#options-list a.form-tooltip').tooltip({
				track: true,
				delay: 0,
				showURL: false,
				extraClass: "fixed-width"
			});

			var orig_updated_time = $('#updated-time').html();
			var orig_most_recent = $('#most-recent').html();
			var current_url = '{{ name_obj.base_url_with_timestamp }}{{ url_subdir }}{% if query_string %}?{{ query_string|safe }}{% endif %}';
			var load_status = 'Loading...';
			var timeout = 30000;
			$('#graph').html('<div id="auth_graph"><div id="graph_loading"><img src="{{ STATIC_URL }}images/loading.gif" alt="' + load_status + '"><br /><strong>' + load_status + '</strong></div></div>');
			$('#notices').html('<div id="notices_loading"><img src="{{ STATIC_URL }}images/loading.gif" alt="' + load_status + '"><br /><strong>' + load_status + '</strong></div>');

			var load_graph = function () {
				$.ajax("{{ analyzed_name_obj.base_url_with_timestamp }}dnssec/auth_graph.js{% if query_string %}?{{ query_string|safe }}{% endif %}", {
					timeout: timeout,
					cache: true,
					success: function(data) {
						var panelWidth = $('#diagram-region').width();
						try {
							var image = new AuthGraph('auth_graph', parseInt(panelWidth*0.99), 1.4);

							//TODO determine whether graph has nodes

							/*
							//XXX image.post_notices('notices');
							// accordion for notices
							$("#notices-region h5").toggle(function() {
									$(this).removeClass("notice-state-default");
									$(this).addClass("notice-state-active");
									$(this).next().toggle('slow');
								},
								function() {
									$(this).removeClass("notice-state-active");
									$(this).addClass("notice-state-default");
									$(this).next().toggle('slow');
							});
							$("#notices-region h5").addClass("notice-state-default");
							$("#notices-region h5").next().hide();
							*/

							image.draw();
							$('#graph-hint').html('Mouse over and click elements in the graph below to see more detail.');
							/*
							if (image.updated != null) {
								var updated_str_iso = image.updated.toISOString();
								var updated_str = updated_str_iso.replace("T", " ").substring(0, 19);
								if (image.page_url != null) {
									$('#updated-time').html('<strong><a href="' + image.page_url + '">' + updated_str + ' UTC</a></strong> (<abbr class="timeago" title="' + updated_str_iso + '"></abbr>)</span>');
								} else {
									$('#updated-time').html('<strong>' + updated_str + ' UTC</strong> (<abbr class="timeago" title="' + updated_str_iso + '"></abbr>)</span>');
								}
								$('#updated-time abbr.timeago').timeago();
								$('#most-recent').html(orig_most_recent);
							}
							*/
						} catch (err) {
							$.cookie("graph_load_error", err);
							load_graph_alternate();
							$('#updated-time').html(orig_updated_time);
							$('#most-recent').html(orig_most_recent);
							$('#updated-time abbr.timeago').timeago();
						}
					},
					complete: function(jqXHR, textStatus) {
						if (textStatus == "success" || textStatus == "notmodified") {
							$('#graph_loading').remove();
							$('#notices_loading').remove();
							return;
						}
						$.cookie("graph_load_error", "Ajax load of graph failed with status '" + textStatus + "'.");
						/*
						var msg;
						if (textStatus == "timeout") {
							msg = 'Loading the analysis has timed out.';
						} else {
							msg = 'There was an error loading the analysis.';
						}
						if (confirm(msg + '  Some information will not be available.  Try again?')) {
							load_graph();
						} else {
						*/
							load_graph_alternate();
							$('#graph_loading').remove();
							$('#notices_loading').remove();
							$('#updated-time').html(orig_updated_time);
							$('#most-recent').html(orig_most_recent);
							$('#updated-time abbr.timeago').timeago();
						/*
						}
						*/
					}
				});
			};

			var load_graph_alternate = function () {
			
				$('#graph-hint').html('We were unable to load the interactive version of the graph.');
				$('#graph').html('<img id="auth_graph" src="{{ analyzed_name_obj.base_url_with_timestamp }}dnssec/auth_graph.png{% if query_string %}?{{ query_string|safe }}{% endif %}" alt="DNSSEC authentication graph" />');
			};

			load_graph();
		});

		$(window).load(function() {
			// viz image sizing
			if ($('#auth_graph.img') || $('#auth_graph.object')) {
				var widthImg = $('#auth_graph').width();
				var widthPanel = $('#diagram-region').width();
				if (widthImg > widthPanel){
					$('#auth_graph').css('width','99%');
				}
				$('#auth_graph').show();

			}
		});
		-->
	</script>
	{% endif %}
{% endblock %}

{% block page_content %}
	{% block dnssec_options %}
	{% include "dnssec_options.html" %}
	{% endblock %}

	<!-- VISUALIZATION DATA -->
	<div id="viz">
		<div id="viz-headers">
			<div id="notices-header">
				Notices
			</div>
			<div id="diagram-header">
				DNSSEC Authentication Chain
			</div>
		</div> <!-- viz-headers -->

		<div id="notices-region">
			<div id="notices">
			{% for cat, subcat_list in notices.items %} 
			{% if subcat_list %}
			<div class="notice-category">
			<h4><img src="{{ STATIC_URL }}images/dnssec_legend/{{ cat|slugify }}.png" alt="{{ cat|capfirst }}" class="header-icon" />{{ cat|capfirst }}</h4>
				{% for subcat, items in subcat_list.items %}
					{% if items %}
					<div class="{{ subcat|lower|slugify }}">
						<h5>{{ subcat|lower|slugify|capfirst }} <span class="count">({{ items|length }})</span></h5>
						<div>
							<ul>
							{% for item in items %}
							<li>
								{{ item }}
							</li>
							{% endfor %}
							</ul>
						</div>
					</div>
					{% endif %}
				{% endfor %}
			</div>
			{% endif %}
			{% endfor %}
			</div>

			<div id="dnssec-legend">
				<h3>DNSKEY legend</h3>
				<a href="/doc/dnssec/">Full legend</a><br />
				<table>
					<tr><td><img src="{{ STATIC_URL }}images/dnssec_legend/dnskey_sep.png" alt="SEP bit set" /></td><td>SEP bit set</td></tr>
					<tr><td><img src="{{ STATIC_URL }}images/dnssec_legend/dnskey_revoke.png" alt="Revoke bit set" /></td><td>Revoke bit set</td></tr>
					<tr><td><img src="{{ STATIC_URL }}images/dnssec_legend/trust_anchor.png" alt="Trust anchor" /></td><td>Trust anchor</td></tr>
					<!--tr><td><img src="{{ STATIC_URL }}images/dnssec_legend/alias_dep.png" alt="Alias dependency" /></td><td>Alias dependency</td></tr-->
				</table>
			</div>

			<div id="see-also">
				<h3>See also</h3>
				<a href="http://dnssec-debugger.verisignlabs.com/{{ name_obj.to_text }}">DNSSEC Debugger</a> by <a href="http://labs.verisign.com/">Verisign Labs</a>.
			</div>

		</div> <!-- notices-region -->

		<div id="diagram-region">
			<div id="graph-download">
				Download: <a href="{{ analyzed_name_obj.base_url_with_timestamp }}dnssec/auth_graph.png?download=1{% if query_string %}&{{ query_string|safe }}{% endif %}">png</a> | <a href="{{ analyzed_name_obj.base_url_with_timestamp }}dnssec/auth_graph.svg?download=1{% if query_string %}&{{ query_string|safe }}{% endif %}">svg</a><br />
			</div>

			<div id="graph-hint">
			{% if use_js %}
			<noscript>
				<div>
				<img alt="Warning" src="{{ STATIC_URL }}images/dnssec_legend/warning.png" />
				JavaScript doesn't appear to be be enabled in your browser. 
					Please enable JavaScript, or <a href="?{% if query_string %}{{ query_string|safe }}&{% else %}{% endif %}no_js=1">click here</a> to view an alternate version of this page, that includes a more detailed analysis.
				</div>
			</noscript>
			{% else %}
				<div>
				<img alt="Warning" src="{{ STATIC_URL }}images/dnssec_legend/warning.png" />
					JavaScript is required to make the graph below interactive.
				</div>
			{% endif %}
			</div>

			<div id="graph">
				{% if use_js %}
				<noscript>
				{% endif %}
					<div><img id="auth_graph" src="{{ analyzed_name_obj.base_url_with_timestamp }}dnssec/auth_graph.png{% if query_string %}?{{ query_string|safe }}{% endif %}" alt="DNSSEC authentication graph" /></div>
				{% if use_js %}
				</noscript>
				{% endif %}
			</div>

				<br style="clear: both;" />
		</div> <!-- diagram -->	
		<br style="clear: both;" />

	</div> <!-- viz -->

{% endblock %}
