#!/usr/bin/env python

import collections
import datetime
import getopt
import json
import logging
import sys

import dns.name

from dnsviz.analysis import get_client_addresses, NetworkConnectivityException, _resolver
import dnsviz.format as fmt
from dnsvizwww.models import DomainNameAnalysis, DBAnalyst

logger = logging.getLogger('dnsviz.analysis')

def usage():
    sys.stderr.write('''Usage: %s [ options ] ( -f <filename> | <domain name> [... ] )

Options:
    -f <filename>  - read names from a file (one name per line), instead of from command line
    -d <level>     - set debug level to a value from 0 to 3, with increasing verbosity (default: 1 or WARNING)
    -r <filename>  - read analysis from a file, instead of querying servers (use "-" for stdin)
    -a <ancestor>  - analyze ancestry of name through ancestor, instead of just name itself (use "-a ." or full ancestral analysis) (default: analyze only the name itself)
    -y             - read in yaml, instead of json
''' % sys.argv[0])

def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'f:d:r:ya:')
    except getopt.GetoptError:
        usage()
        sys.exit(1)

    opts = dict(opts)
    if ('-f' in opts and args) or not ('-f' in opts or args):
        usage()
        sys.exit(1)

    if '-a' in opts:
        ceiling = dns.name.from_text(opts['-a'])
    else:
        ceiling = None

    try:
        val = int(opts.get('-d', 1))
    except ValueError:
        usage()
        sys.exit(1)

    if val < 0 or val > 3:
        usage()
        sys.exit(1)

    if val > 2:
        debug_level = logging.DEBUG
    elif val > 1:
        debug_level = logging.INFO
    elif val > 0:
        debug_level = logging.WARNING
    else:
        debug_level = logging.ERROR
    handler = logging.StreamHandler()
    handler.setLevel(debug_level)
    logger.addHandler(handler)
    logger.setLevel(debug_level)

    #TODO: support unicode
    if '-f' in opts:
        names = []
        with open(opts['-f']) as f:
            for line in f:
                names.append(dns.name.from_text(line.strip()))
    else:
        names = map(dns.name.from_text, args)

    name_objs = []
    if '-r' in opts:
        if opts['-r'] == '-':
            analysis_str = sys.stdin.read()
        else:
            analysis_str = open(opts['-r']).read()
        if '-y' in opts:
            import yaml
            analysis_structured = yaml.load(analysis_str)
        else:
            analysis_structured = json.loads(analysis_str)
        for name in names:
            name_objs.append(DomainNameAnalysis.deserialize(name, analysis_structured))
    else:
        client_ipv4, client_ipv6 = get_client_addresses()
        if client_ipv4 is None and client_ipv6 is None:
            raise NetworkConnectivityException('No network interfaces available for analysis!')
        cache = {}
        #start = datetime.datetime.now(fmt.utc).replace(microsecond=0)
        for name in names:
            if ceiling is not None and name.is_subdomain(ceiling):
                c = ceiling
            else:
                c = name
            #a = DBAnalyst(name, client_ipv4=client_ipv4, client_ipv6=client_ipv6, ceiling=c, analysis_cache=cache, start_time=start)
            a = DBAnalyst(name, client_ipv4=client_ipv4, client_ipv6=client_ipv6, ceiling=c, analysis_cache=cache)
            name_objs.append(a.analyze())

    d = collections.OrderedDict()
    for name_obj in name_objs:
        name_obj.serialize(d)

if __name__ == "__main__":
    main()
